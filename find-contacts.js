#!/usr/bin/env node

import { SSMClient, GetParameterCommand } from '@aws-sdk/client-ssm';
import axios from 'axios';

const ssmClient = new SSMClient({region: 'us-east-2'});
const GHL_BASE_URL = 'https://services.leadconnectorhq.com';
const GHL_API_VERSION = '2021-07-28';

async function getValidGhlToken() {
    const command = new GetParameterCommand({
        Name: '/vapi-ghl-integration/ghl-access-token',
        WithDecryption: true
    });
    const result = await ssmClient.send(command);
    return result.Parameter.Value;
}

async function testContactAndNote() {
    try {
        const accessToken = await getValidGhlToken();
        const locationId = 'Tty8tmfsIBN4DdOVzgVa'; // From JWT token
        
        console.log('ğŸ¢ Using location ID:', locationId);
        
        // First, let's search for existing contacts
        console.log('ğŸ” Searching for existing contacts...');
        const searchResponse = await axios.get(`${GHL_BASE_URL}/contacts/`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Version': GHL_API_VERSION,
                'Content-Type': 'application/json'
            },
            params: {
                locationId: locationId,
                limit: 5
            }
        });
        
        console.log('ğŸ“ Existing contacts:', JSON.stringify(searchResponse.data, null, 2));
        
        let testContactId;
        
        if (searchResponse.data.contacts && searchResponse.data.contacts.length > 0) {
            // Use the first existing contact
            testContactId = searchResponse.data.contacts[0].id;
            console.log(`âœ… Using existing contact ID: ${testContactId}`);
        } else {
            // Create a new test contact
            console.log('ğŸ“ Creating new test contact...');
            const contactData = {
                firstName: 'Test',
                lastName: 'Contact',
                phone: '+15551234567',
                email: 'test.contact@example.com',
                locationId: locationId
            };
            
            const createResponse = await axios.post(`${GHL_BASE_URL}/contacts/`, contactData, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Version': GHL_API_VERSION,
                    'Content-Type': 'application/json'
                }
            });
            
            testContactId = createResponse.data.contact.id;
            console.log(`âœ… Test contact created with ID: ${testContactId}`);
        }
        
        // Now test creating a note
        console.log('ğŸ“ Creating test note...');
        const noteBody = `ğŸ“ VAPI Call Summary TEST
Call ID: test-call-direct
Duration: 19 minutes
Date: 9/11/2025

ğŸ¯ Key Information Extracted:
â€¢ Name: Test Contact
â€¢ Email: test.contact@example.com
â€¢ Phone: +15551234567

ğŸ“ Full Transcript:
"This is a test transcript for testing the notes feature."

ğŸµ Audio Recording:
Call ID: test-call-direct (Contact VAPI support for audio access)

Generated by VAPI-GHL Integration`;

        const noteResponse = await axios.post(`${GHL_BASE_URL}/contacts/${testContactId}/notes`, {
            body: noteBody
        }, {
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Version': GHL_API_VERSION,
                'Content-Type': 'application/json'
            }
        });
        
        console.log('ğŸ“ Note creation API response:', JSON.stringify(noteResponse.data, null, 2));
        console.log(`âœ… Note created successfully! Note ID: ${noteResponse.data?.id || noteResponse.data}`);
        console.log('ğŸ‰ Contact notes functionality is working!');
        
        return testContactId;
        
    } catch (error) {
        console.error('âŒ Error details:');
        console.error('Message:', error.message);
        console.error('Code:', error.code);
        console.error('Stack:', error.stack);
        if (error.response) {
            console.error('Response Status:', error.response.status);
            console.error('Response Data:', error.response.data);
            console.error('Response Headers:', error.response.headers);
        }
    }
}

testContactAndNote();